<!DOCTYPE html>
<html lang="en" data-theme="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Token Usage Dashboard - PRISMiTY.AI</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="icon" href="LOGO" type="image/png" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      .compact-nav {
        background: var(--bg-secondary);
        border-bottom: 1px solid var(--border-color);
        padding: 12px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        height: 50px;
      }

      .nav-logo {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 1.2rem;
        font-weight: 600;
        color: var(--text-primary);
      }

      .nav-logo img {
        width: 32px;
        height: 32px;
        object-fit: contain;
        border-radius: 6px;
        background: rgba(255, 255, 255, 0.05);
        padding: 2px;
      }

      .back-link {
        color: var(--primary);
        text-decoration: none;
        font-size: 0.9rem;
        padding: 6px 12px;
        border-radius: var(--radius);
        background: rgba(99, 102, 241, 0.1);
        transition: var(--transition);
      }

      .back-link:hover {
        background: rgba(99, 102, 241, 0.2);
      }

      .dashboard-container {
        padding: 20px;
        max-width: 800px;
        margin: 0 auto;
      }

      .dashboard-header {
        text-align: center;
        margin-bottom: 30px;
      }

      .dashboard-title {
        font-size: 2rem;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 8px;
      }

      .dashboard-subtitle {
        color: var(--text-muted);
        font-size: 1rem;
      }

      .usage-card {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-lg);
        padding: 24px;
        box-shadow: var(--shadow);
      }

      .usage-overview {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 20px;
        margin-bottom: 24px;
      }

      .usage-stat {
        text-align: center;
        padding: 16px;
        background: var(--bg-tertiary);
        border-radius: var(--radius);
        border: 1px solid var(--border-color);
      }

      .stat-value {
        display: block;
        font-size: 2rem;
        font-weight: 700;
        color: var(--primary);
        margin-bottom: 4px;
      }

      .stat-label {
        font-size: 0.85rem;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .chart-section {
        background: var(--bg-tertiary);
        border-radius: var(--radius);
        padding: 20px;
        border: 1px solid var(--border-color);
        margin-bottom: 20px;
      }

      .chart-container {
        position: relative;
        height: 300px;
      }

      .usage-status {
        padding: 16px;
        border-radius: var(--radius);
        text-align: center;
        font-weight: 500;
        font-size: 0.9rem;
      }

      .status-good {
        background: rgba(16, 185, 129, 0.1);
        color: #10b981;
        border: 1px solid rgba(16, 185, 129, 0.2);
      }

      .status-warning {
        background: rgba(245, 158, 11, 0.1);
        color: #f59e0b;
        border: 1px solid rgba(245, 158, 11, 0.2);
      }

      .status-danger {
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
        border: 1px solid rgba(239, 68, 68, 0.2);
      }

      .loading-state {
        text-align: center;
        padding: 40px;
        color: var(--text-muted);
      }

      .loading-spinner {
        width: 32px;
        height: 32px;
        border: 3px solid var(--bg-tertiary);
        border-top: 3px solid var(--primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 16px;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      @media (max-width: 768px) {
        .dashboard-container {
          padding: 15px;
        }

        .dashboard-title {
          font-size: 1.5rem;
        }

        .usage-card {
          padding: 16px;
        }

        .chart-container {
          height: 250px;
        }

        .stat-value {
          font-size: 1.5rem;
        }
      }
    </style>
  </head>
  <body>
    <!-- Compact Navigation -->
    <nav class="compact-nav">
      <div class="nav-logo">
        <img src="LOGO.png" alt="Prismity Logo" />
        <span>Token Usage</span>
      </div>
      <a href="/" class="back-link">‚Üê Back to Chat</a>
    </nav>

    <div class="dashboard-container">
      <div class="dashboard-header">
        <h1 class="dashboard-title">Your Token Usage</h1>
        <p class="dashboard-subtitle">Current usage for your account</p>
      </div>

      <div id="loading-state" class="loading-state">
        <div class="loading-spinner"></div>
        <p>Loading usage data...</p>
      </div>

      <div id="usage-dashboard" class="usage-card" style="display: none;">
        <div class="usage-overview">
          <div class="usage-stat">
            <span id="tokens-used" class="stat-value">0</span>
            <span class="stat-label">Tokens Used</span>
          </div>
          <div class="usage-stat">
            <span id="remaining-tokens" class="stat-value">100</span>
            <span class="stat-label">Remaining</span>
          </div>
          <div class="usage-stat">
            <span id="usage-percentage" class="stat-value">0%</span>
            <span class="stat-label">Usage</span>
          </div>
        </div>

        <div class="chart-section">
          <div class="chart-container">
            <canvas id="usageChart"></canvas>
          </div>
        </div>

        <div id="usage-status" class="usage-status status-good">
          You're doing great! Keep using Ergovia-AI effectively.
        </div>
      </div>
    </div>

    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="auth.js"></script>
    <script>
      let currentUsage = { tokens: 0 };
      const maxTokens = 100;
      let usageChart = null;

      async function loadTokenUsage() {
        try {
          const response = await fetch('/api/token-usage');
          if (response.ok) {
            const data = await response.json();
            currentUsage = data.usage || { tokens: 0 };
            updateDashboard();
            createChart();
          } else {
            console.error('Failed to load token usage data');
            // Show default data
            updateDashboard();
            createChart();
          }
        } catch (error) {
          console.error('Error loading token usage:', error);
          // Show default data
          updateDashboard();
          createChart();
        } finally {
          document.getElementById('loading-state').style.display = 'none';
          document.getElementById('usage-dashboard').style.display = 'block';
        }
      }

      function updateDashboard() {
        const tokensUsed = currentUsage.tokens || 0;
        const remaining = Math.max(0, maxTokens - tokensUsed);
        const percentage = Math.min((tokensUsed / maxTokens) * 100, 100);

        // Update stats
        document.getElementById('tokens-used').textContent = tokensUsed;
        document.getElementById('remaining-tokens').textContent = remaining;
        document.getElementById('usage-percentage').textContent = Math.round(percentage) + '%';

        // Update status
        const statusElement = document.getElementById('usage-status');
        statusElement.classList.remove('status-good', 'status-warning', 'status-danger');

        if (percentage >= 90) {
          statusElement.classList.add('status-danger');
          statusElement.textContent = 'Almost at limit! Consider upgrading for unlimited access.';
        } else if (percentage >= 70) {
          statusElement.classList.add('status-warning');
          statusElement.textContent = 'High usage detected. Monitor your token consumption.';
        } else {
          statusElement.classList.add('status-good');
          statusElement.textContent = 'You\'re doing great! Keep using Ergovia-AI effectively.';
        }
      }

      function createChart() {
        const ctx = document.getElementById('usageChart').getContext('2d');
        const tokensUsed = currentUsage.tokens || 0;
        const remaining = Math.max(0, maxTokens - tokensUsed);

        if (usageChart) {
          usageChart.destroy();
        }

        usageChart = new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: ['Used', 'Remaining'],
            datasets: [{
              data: [tokensUsed, remaining],
              backgroundColor: [
                'rgba(99, 102, 241, 0.8)',
                'rgba(156, 163, 175, 0.2)'
              ],
              borderColor: [
                'rgba(99, 102, 241, 1)',
                'rgba(156, 163, 175, 0.3)'
              ],
              borderWidth: 2
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'bottom',
                labels: {
                  color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary').trim(),
                  padding: 15,
                  font: {
                    size: 12
                  }
                }
              }
            },
            cutout: '70%'
          }
        });
      }

      // Initialize
      document.addEventListener('DOMContentLoaded', async () => {
        await loadTokenUsage();
        lucide.createIcons();
      });
    </script>
  </body>
</html>